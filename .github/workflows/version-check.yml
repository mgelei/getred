name: Version Bump Check

on:
  pull_request:
    branches: [master]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR branch version
        id: pr-version
        run: |
          PR_VERSION=$(grep -Po '(?<=^version = ")[^"]+' pyproject.toml)
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "PR branch version: $PR_VERSION"

      - name: Get master branch version
        id: master-version
        run: |
          MASTER_VERSION=$(git show origin/master:pyproject.toml | grep -Po '(?<=^version = ")[^"]+')
          echo "version=$MASTER_VERSION" >> $GITHUB_OUTPUT
          echo "Master branch version: $MASTER_VERSION"

      - name: Compare versions
        run: |
          if [ "${{ steps.pr-version.outputs.version }}" == "${{ steps.master-version.outputs.version }}" ]; then
            echo "❌ Version bump required!"
            echo "Current version in PR: ${{ steps.pr-version.outputs.version }}"
            echo "Version in master: ${{ steps.master-version.outputs.version }}"
            echo ""
            echo "Please update the version in pyproject.toml before merging to master."
            exit 1
          else
            echo "✅ Version bumped successfully!"
            echo "Old version (master): ${{ steps.master-version.outputs.version }}"
            echo "New version (PR): ${{ steps.pr-version.outputs.version }}"
          fi
